<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Product Details — Badri CNC Tooling</title>
<style>
  :root{--accent:#1e3d59;--muted:#6c757d}
  *{box-sizing:border-box}
  body{font-family:Inter, Arial, sans-serif;margin:0;background:#f6f7fb;color:#111}
  .site-header{display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--accent);color:white}
  .logo{height:44px}
  .container{max-width:1100px;margin:18px auto;padding:0 16px}
  .row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .back-btn{background:#fff;border:1px solid #ddd;padding:8px 12px;border-radius:6px;cursor:pointer}
  .search-input{margin-left:auto}
  input[type="search"]{padding:8px 10px;border:1px solid #ccc;border-radius:6px}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 6px 18px rgba(10,20,40,0.04)}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:var(--accent);color:#fff}
  .muted{color:var(--muted)}
  .no-data{text-align:center;padding:18px;font-style:italic}
  @media(max-width:600px){.container{padding:0 10px}}
</style>
</head>
<body>
  <header class="site-header">
    <img class="logo" src="https://via.placeholder.com/160x44?text=Badri+CNC" alt="Logo">
    <div>
      <div style="font-weight:700">Badri CNC Tooling</div>
      <div style="font-size:13px;color:#d6e3ff" id="pageSubtitle">Product details</div>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <button class="back-btn" onclick="goBack()">← Back</button>
      <div style="margin-left:12px"><strong id="pageTitle">Product</strong></div>
      <div class="search-input">
        <input id="searchInput" type="search" placeholder="Search size (e.g. 10mm)"/>
      </div>
    </div>

    <div id="loading" class="muted">Loading sizes…</div>
    <div id="noData" class="no-data" style="display:none"></div>

    <table id="productTable" style="display:none">
      <thead><tr><th>Brand</th><th>Product</th><th>Size</th><th>Price</th></tr></thead>
      <tbody id="product-table-body"></tbody>
    </table>
  </main>

<script>
/* ------------ CONFIG: your published CSV link ----------- */
const CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4gOi3FoAsMGgM_3yQnfJwLAPVd0Uj-fo8qBXg9m2kWGp_AeKee_zmqb_XejPW4hs2OGAIPsccALkI/pub?output=csv";
/* ------------------------------------------------------ */

console.log("product.html loaded");

function goBack(){
  const p = new URLSearchParams(location.search);
  const brand = p.get('brand') || '';
  if(brand) location.href = `brand.html?brand=${encodeURIComponent(brand)}`;
  else location.href = 'index.html';
}

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h=>h.replace(/^"|"$/g,'').trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'').trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h] = cols[i] !== undefined ? cols[i] : '');
    return obj;
  });
}

function formatPrice(raw){
  if(!raw) return '';
  const n = Number(String(raw).replace(/[^0-9.\-]/g,''));
  if(!isNaN(n)) return '\u20B9 ' + n.toLocaleString('en-IN');
  return raw;
}

(async function(){
  const params = new URLSearchParams(location.search);
  const brandParam = (params.get('brand')||'').trim();
  const productParam = (params.get('product')||'').trim();
  console.log("params:", {brandParam, productParam});

  document.getElementById('pageTitle').textContent = productParam ? `${productParam} — ${brandParam}` : 'Product details';
  document.getElementById('pageSubtitle').textContent = brandParam;

  try {
    console.log("Fetching CSV:", CSV_LINK);
    const res = await fetch(CSV_LINK);
    console.log("fetch status:", res.status);
    if(!res.ok) throw new Error('Fetch failed '+res.status);
    const txt = await res.text();
    console.log("CSV length:", txt.length);
    const rows = parseCSV(txt);
    console.log("parsed rows:", rows.length);

    const normalized = rows.map(r=>({
      Brand: (r.Brand||r.brand||'').trim(),
      Product: (r.Product||r.product||'').trim(),
      Size: (r.Size||r.size||'').trim(),
      Price: (r.Price||r.price||'').trim()
    }));

    // filter exact product (case-insensitive)
    const filtered = normalized.filter(r =>
      r.Brand.toLowerCase() === brandParam.toLowerCase() &&
      r.Product.toLowerCase() === productParam.toLowerCase()
    );

    document.getElementById('loading').style.display = 'none';
    if(!filtered.length){
      // show helpful message + available products for brand
      const available = [...new Set(normalized.filter(r=>r.Brand.toLowerCase()===brandParam.toLowerCase()).map(r=>r.Product))].filter(Boolean);
      document.getElementById('noData').style.display = 'block';
      document.getElementById('noData').textContent = `No sizes found for "${productParam}". Available products for ${brandParam}: ${available.join(', ') || '(none)'}`;
      console.log("available products:", available);
      return;
    }

    const tbody = document.getElementById('product-table-body');
    tbody.innerHTML = '';
    filtered.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.Brand}</td><td>${r.Product}</td><td>${r.Size}</td><td>${formatPrice(r.Price)}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('productTable').style.display = 'table';

    // wire search
    const search = document.getElementById('searchInput');
    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase();
      const rows = tbody.querySelectorAll('tr');
      let any = false;
      rows.forEach(row=>{
        const size = row.cells[2].textContent.toLowerCase();
        const price = row.cells[3].textContent.toLowerCase();
        const show = (!q) || size.includes(q) || price.includes(q);
        row.style.display = show ? '' : 'none';
        if(show) any = true;
      });
      if(!any){
        document.getElementById('noData').style.display = 'block';
        document.getElementById('noData').textContent = `No sizes match "${search.value.trim()}"`;
        document.getElementById('productTable').style.display = 'none';
      } else {
        document.getElementById('noData').style.display = 'none';
        document.getElementById('productTable').style.display = 'table';
      }
    });

    console.log("filtered rows count:", filtered.length);

  } catch(err){
    console.error(err);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('noData').style.display = 'block';
    document.getElementById('noData').textContent = 'Error loading data — check console.';
  }
})();
</script>
</body>
</html>
